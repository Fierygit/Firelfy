[toc]



### 

### 网络层

#### 概述

路由器的主要作用便是将数据报从入链路转发到出链路

主要有三个组件

- 第一个组件 IP 协议
- 第二个组件 路由选择算法
- 第三个组件是差错

##### 转发和路由选择

- 转发

当一个分组到达路由器的一条输入链路时， 路由器必须将该分组移动到适当的输出链路

- 路由选择

当分组从发送方流向接收方时， 网络层必须决定这些分组所采用的路由或路径

网络层提供的是尽力而为的服务， why？

#### 虚电路和数据报网络

- 虚电路网络

仅在网络层提供连接服务的网络，每一台路由器都要参与虚电路的建立，并且知道所有的虚电路， 路由器要分配 vc 号

- 数据报网络

仅在网络层提供无连接服务的网络

每隔 1- 5 分钟更新一次转发表

#### 路由器的工作原理

- 接受帧	
- 放入队列（缓存管理）	
- 交换
  - 经过内存交换（多个线路分速率）
  - 经总线交换
  - 经互联网交换

#### 因特网中的转发和编址







### 链路层

链路层的主体部分是在网络适配器中实现的， 网络适配器有时也称为网络接口卡（网卡 Network Interface Card， NIC）。

一句话概述其工作过程就是将网络层的分组数据包组织起来，通过物理层以比特流的形式发送。



#### 差错检测的3种技术

##### 1、 奇偶校验（描述原理）

包含一位附加比特位， 所有的 1 的比特的数量为**偶数**。



##### 2、检验和 checksum（传输层）

一个d 比特的数据看做一个k比特整数的序列处理，将这些整数加起来的和作为检测差错比特。

<font color='gree'> 传输层的检测方法？</font>

##### 3、循环冗余检测 CRC（用于链路层）

> D ·  2 ^r^  XOR R = nG

数据段： D， 冗余检测段： R， r位的R，

>  R = remainder( D · 2^r^ / G ) 

数据段 D 一直除以 G 就可以得到 2^r^  和 余数R

通过发送端和接受端都根据G 来计算出 R，原理是什么？



###### 为什么传输层用 checksum 而链路层用CRC？

因为传输层是运行于os 的软件实现，需要简单快速， 链路层是在适配器中用专门的硬件实现的，能够快速执行 CRC 操作！



#### 多路访问链路协议

网络链路类型

- 点对点链路
- 广播链路： 共享一个信道



###### 信道划分协议

- 时分多路复用
- 频分多路复用
- 码分多址（CDMA）

###### 随机接入协议

- 时隙ALOHA

随机开始发送， 有冲突时以一定概率延时一些时隙

当 N 个节点访问的时候， 效率为 37 %，低！

- ALOHA

随机开发发送，有冲突时一定概率继续发送

效率更低！ 为时隙的一半

- 载波侦听多路访问（CSMA/CD carrier sense multiple access with collision detection）

理论效率接近 1

###### 轮流协议

- 轮询协议

主节点轮询访问每一个节点，控制发送，解决冲突问题， 但是引入了轮询时延和主节点单点故障

- 令牌传递协议

传递令牌来作为主节点



#### 交换局域网

##### 链路层寻址和 ARP

- MAC 地址

48位，每一个适配器（网络接口） 有链路层地址，不是主机。



###### 为什么要有 MAC地址？

> 1、 局域网是为任意的网络层协议设计的， 不只是 IP 和 因特网。

>  2、如果是IP地址，存储于 RAM 每次都要重新配置

>  如果将ip存在适配器中，那么每次发的信息都会中断主机



- 地址解析协议（ARP）

将 IP 解析为 MAC 地址， 类似DNS， 属于网络层和链路层。



**路由器的每一个接口都有一个  ARP 模块和适配器！**

路由器和交换机的区别

路由器是第3 层的， 交换机是第二层（链路层）， 对于主机和交换机是透明的存在



##### 以太网

以太网帧的第一段为数据字段， 最大为 1500， 因此 MTU  =  1500



#### 浏览器访问的流程

主机 	--	交换机A	--  路由器A

##### 准备阶段一： DHCP， UDP， IP， 以太网帧

1、 主机运行dhcp 服务， 没有ip的情况下， 发送DHCP 报文

2、 以太网帧封装 DHCP 帧，进行广播

3、交换机A广播以太网帧

4、路由器A 接受到DHCO 报文， 进行解析UDP

5、封装 IP 等信息返回给主机

6、交换接收到会保存交换机表，下次不用再访问

7、主机发送 DHCP ACK

至此已经获得了 IP 地址可以发送数据了

##### 准备阶段二：DNS和ARP

8、 对于浏览器链接首先要解析出 IP， 发送 DNS 报文

9、 网关路由器的 MAC 还不知道， 封装 ARP 协议 

10、封装网关的IP 进行 ARP 广播

11、 网关收到了ARP 报文帧，返回 MAC 地址

12、 此时主机得到网关的 MAC

13、 现在可以发动数据了，发送 DNS数据

##### 准备阶段三： 路由到DNS服务器

14、 根据路由表发送 DNS 数据到 DNS的路由器上

15、 DNS 的路由器收到消息后再转发到 DNS 服务器上，（BGP协议）

16、  DNS 返回IP给主机

17、 获得了 目的主机的 ip

##### CS 交互： TCP HTTP

18、 首先3次握手，封装 目的 MAC 地址为网关路由器的的帧， 后面就直接BGP 跳转了。。。 MAC 只是局部的

19、 使用转发表一直到目的主机









 



































































